name: Pulumi

on:
    workflow_dispatch:

jobs:
    pulumi:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v2
              with:
                node-version: '22'

            - name: Install dependencies
              run: npm install

            - name: Install Pulumi
              run: npm install -g @pulumi/pulumi

            - name: Configure Pulumi
              run: pulumi login

            - name: Pulumi Preview
              run: pulumi preview
              env:
                PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

            - name: Pulumi Update
              if: github.ref == 'refs/heads/main'
              run: pulumi up --yes
              env:
                PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}